@model List<DocumentFlow.Models.ViewModels.UserListViewModel>
@{
    ViewData["Title"] = "Управление пользователями";
}

<!-- Page Header -->
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-4">
    <div>
        <h2 class="mb-1 d-flex align-items-center gap-2">
            <i class="bi bi-people-fill text-primary"></i>
            Пользователи
        </h2>
        <p class="text-muted mb-0">Управление пользователями системы</p>
    </div>
    <a asp-action="CreateUser" class="btn btn-primary">
        <i class="bi bi-person-plus-fill me-1"></i>Добавить
    </a>
</div>

<!-- Stats -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="card">
            <div class="card-body d-flex align-items-center gap-3">
                <div class="icon-box icon-box-primary">
                    <i class="bi bi-people-fill"></i>
                </div>
                <div>
                    <div class="h4 mb-0">@Model.Count</div>
                    <small class="text-muted">Всего</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card">
            <div class="card-body d-flex align-items-center gap-3">
                <div class="icon-box icon-box-success">
                    <i class="bi bi-check-circle-fill"></i>
                </div>
                <div>
                    <div class="h4 mb-0">@Model.Count(u => u.IsActive)</div>
                    <small class="text-muted">Активных</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Users Table -->
<div class="data-table">
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>Пользователь</th>
                    <th class="d-none d-md-table-cell">Отдел / Должность</th>
                    <th>Роли</th>
                    <th>Статус</th>
                    <th class="d-none d-lg-table-cell">Регистрация</th>
                    <th style="width: 100px;"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in Model)
                {
                    <tr class="@(!user.IsActive ? "opacity-50" : "")">
                        <td>
                            <div class="d-flex align-items-center gap-3">
                                <div class="user-avatar @(!user.IsActive ? "bg-secondary" : "")">
                                    @{
                                        var names = user.FullName.Split(' ');
                                        var initials = names.Length >= 2 ? $"{names[0][0]}{names[1][0]}" : user.FullName.Substring(0, Math.Min(2, user.FullName.Length));
                                    }
                                    <span style="font-size: 0.75rem;">@initials.ToUpper()</span>
                                </div>
                                <div>
                                    <div class="fw-semibold">@user.FullName</div>
                                    <small class="text-muted">@user.Email</small>
                                </div>
                            </div>
                        </td>
                        <td class="d-none d-md-table-cell">
                            @if (!string.IsNullOrEmpty(user.Department) || !string.IsNullOrEmpty(user.Position))
                            {
                                <div class="small">
                                    @if (!string.IsNullOrEmpty(user.Department))
                                    {
                                        <div>@user.Department</div>
                                    }
                                    @if (!string.IsNullOrEmpty(user.Position))
                                    {
                                        <div class="text-muted">@user.Position</div>
                                    }
                                </div>
                            }
                            else
                            {
                                <span class="text-muted">—</span>
                            }
                        </td>
                        <td>
                            <div class="d-flex flex-wrap gap-1">
                                @foreach (var role in user.Roles)
                                {
                                    <span class="badge @GetRoleBadgeClass(role)">@GetRoleDisplayName(role)</span>
                                }
                            </div>
                        </td>
                        <td>
                            @if (user.IsActive)
                            {
                                <span class="d-flex align-items-center gap-2">
                                    <span class="status-dot status-dot-success"></span>
                                    <span class="small">Активен</span>
                                </span>
                            }
                            else
                            {
                                <span class="d-flex align-items-center gap-2">
                                    <span class="status-dot status-dot-danger"></span>
                                    <span class="small">Заблокирован</span>
                                </span>
                            }
                        </td>
                        <td class="d-none d-lg-table-cell">
                            <span class="text-muted small">@user.CreatedAt.ToLocalTime().ToString("dd.MM.yyyy")</span>
                        </td>
                        <td>
                            <div class="row-actions">
                                <a asp-action="EditUser" asp-route-id="@user.Id" class="btn btn-sm btn-outline-primary" title="Редактировать">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <form asp-action="ToggleUserStatus" asp-route-id="@user.Id" method="post" class="d-inline">
                                    <button type="submit" class="btn btn-sm @(user.IsActive ? "btn-outline-warning" : "btn-outline-success")"
                                            title="@(user.IsActive ? "Заблокировать" : "Активировать")"
                                            onclick="return confirm('@(user.IsActive ? "Заблокировать" : "Активировать") пользователя?');">
                                        <i class="bi @(user.IsActive ? "bi-lock" : "bi-unlock")"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@functions {
    string GetRoleDisplayName(string role) => role switch
    {
        "Administrator" => "Админ",
        "Manager" => "Руководитель",
        "Employee" => "Сотрудник",
        "ITIntegrator" => "IT",
        _ => role
    };

    string GetRoleBadgeClass(string role) => role switch
    {
        "Administrator" => "bg-danger",
        "Manager" => "bg-warning",
        "Employee" => "bg-info",
        "ITIntegrator" => "bg-primary",
        _ => "bg-secondary"
    };
}
