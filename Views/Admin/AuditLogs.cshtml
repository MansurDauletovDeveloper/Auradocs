@model DocumentFlow.Models.ViewModels.AuditLogListViewModel
@{
    ViewData["Title"] = "Журнал аудита";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-journal-text me-2"></i>Журнал аудита</h2>
    <a asp-action="ExportAuditLogs" asp-route-userId="@Model.UserId" asp-route-actionType="@Model.ActionType" 
       asp-route-startDate="@Model.StartDate?.ToString("yyyy-MM-dd")" asp-route-endDate="@Model.EndDate?.ToString("yyyy-MM-dd")"
       class="btn btn-success">
        <i class="bi bi-download me-1"></i>Экспорт CSV
    </a>
</div>

<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-funnel me-1"></i>Фильтры
    </div>
    <div class="card-body">
        <form asp-action="AuditLogs" method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Пользователь</label>
                <select name="userId" class="form-select">
                    <option value="">Все пользователи</option>
                    @foreach (var user in Model.Users)
                    {
                        <option value="@user.Value" selected="@(Model.UserId == user.Value)">@user.Text</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Тип действия</label>
                <select name="actionType" class="form-select">
                    <option value="">Все действия</option>
                    @foreach (var action in Enum.GetValues<DocumentFlow.Models.Entities.AuditActionType>())
                    {
                        <option value="@action" selected="@(Model.ActionType == action)">
                            @(action switch {
                                DocumentFlow.Models.Entities.AuditActionType.Create => "Создание",
                                DocumentFlow.Models.Entities.AuditActionType.View => "Просмотр",
                                DocumentFlow.Models.Entities.AuditActionType.Edit => "Редактирование",
                                DocumentFlow.Models.Entities.AuditActionType.Delete => "Удаление",
                                DocumentFlow.Models.Entities.AuditActionType.SubmitForApproval => "Отправка на согласование",
                                DocumentFlow.Models.Entities.AuditActionType.Approve => "Согласование",
                                DocumentFlow.Models.Entities.AuditActionType.Reject => "Отклонение",
                                DocumentFlow.Models.Entities.AuditActionType.Download => "Скачивание",
                                DocumentFlow.Models.Entities.AuditActionType.UploadVersion => "Загрузка версии",
                                DocumentFlow.Models.Entities.AuditActionType.RestoreVersion => "Восстановление версии",
                                DocumentFlow.Models.Entities.AuditActionType.AddComment => "Добавление комментария",
                                DocumentFlow.Models.Entities.AuditActionType.Login => "Вход в систему",
                                DocumentFlow.Models.Entities.AuditActionType.Logout => "Выход из системы",
                                DocumentFlow.Models.Entities.AuditActionType.UserModified => "Изменение пользователя",
                                DocumentFlow.Models.Entities.AuditActionType.Archive => "Архивирование",
                                _ => action.ToString()
                            })
                        </option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Дата с</label>
                <input type="date" name="startDate" class="form-control" value="@Model.StartDate?.ToString("yyyy-MM-dd")" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Дата по</label>
                <input type="date" name="endDate" class="form-control" value="@Model.EndDate?.ToString("yyyy-MM-dd")" />
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search me-1"></i>Поиск
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-body">
        @if (Model.Items.Any())
        {
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 160px;">Дата и время</th>
                            <th>Пользователь</th>
                            <th>Действие</th>
                            <th>Документ</th>
                            <th>Описание</th>
                            <th>IP-адрес</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var log in Model.Items)
                        {
                            <tr>
                                <td>@log.Timestamp.ToString("dd.MM.yyyy HH:mm:ss")</td>
                                <td>@log.UserFullName</td>
                                <td>
                                    @{
                                        var (badgeClass, actionText) = log.ActionType switch {
                                            DocumentFlow.Models.Entities.AuditActionType.Create => ("bg-success", "Создание"),
                                            DocumentFlow.Models.Entities.AuditActionType.View => ("bg-info text-dark", "Просмотр"),
                                            DocumentFlow.Models.Entities.AuditActionType.Edit => ("bg-warning text-dark", "Редактирование"),
                                            DocumentFlow.Models.Entities.AuditActionType.Delete => ("bg-danger", "Удаление"),
                                            DocumentFlow.Models.Entities.AuditActionType.SubmitForApproval => ("bg-info text-dark", "На согласование"),
                                            DocumentFlow.Models.Entities.AuditActionType.Approve => ("bg-success", "Согласовано"),
                                            DocumentFlow.Models.Entities.AuditActionType.Reject => ("bg-danger", "Отклонено"),
                                            DocumentFlow.Models.Entities.AuditActionType.Download => ("bg-primary", "Скачивание"),
                                            DocumentFlow.Models.Entities.AuditActionType.UploadVersion => ("bg-secondary", "Загрузка версии"),
                                            DocumentFlow.Models.Entities.AuditActionType.RestoreVersion => ("bg-secondary", "Восстановление версии"),
                                            DocumentFlow.Models.Entities.AuditActionType.AddComment => ("bg-secondary", "Комментарий"),
                                            DocumentFlow.Models.Entities.AuditActionType.Login => ("bg-primary", "Вход"),
                                            DocumentFlow.Models.Entities.AuditActionType.Logout => ("bg-dark", "Выход"),
                                            DocumentFlow.Models.Entities.AuditActionType.UserModified => ("bg-warning text-dark", "Изменение пользователя"),
                                            DocumentFlow.Models.Entities.AuditActionType.Archive => ("bg-secondary", "Архивирование"),
                                            _ => ("bg-secondary", log.ActionType.ToString())
                                        };
                                    }
                                    <span class="badge @badgeClass">@actionText</span>
                                </td>
                                <td>
                                    @if (log.DocumentId.HasValue && !string.IsNullOrEmpty(log.DocumentTitle))
                                    {
                                        <a asp-controller="Documents" asp-action="Details" asp-route-id="@log.DocumentId">
                                            @log.DocumentTitle
                                        </a>
                                    }
                                    else
                                    {
                                        <span class="text-muted">—</span>
                                    }
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(log.Description))
                                    {
                                        @log.Description
                                    }
                                    else
                                    {
                                        <span class="text-muted">—</span>
                                    }
                                </td>
                                <td><code>@log.IpAddress</code></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            
            <nav aria-label="Навигация по страницам">
                <ul class="pagination justify-content-center mb-0">
                    @if (Model.CurrentPage > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" asp-action="AuditLogs" asp-route-page="@(Model.CurrentPage - 1)"
                               asp-route-userId="@Model.UserId" asp-route-actionType="@Model.ActionType"
                               asp-route-startDate="@Model.StartDate?.ToString("yyyy-MM-dd")" asp-route-endDate="@Model.EndDate?.ToString("yyyy-MM-dd")">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                    }
                    @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                    {
                        <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                            <a class="page-link" asp-action="AuditLogs" asp-route-page="@i"
                               asp-route-userId="@Model.UserId" asp-route-actionType="@Model.ActionType"
                               asp-route-startDate="@Model.StartDate?.ToString("yyyy-MM-dd")" asp-route-endDate="@Model.EndDate?.ToString("yyyy-MM-dd")">
                                @i
                            </a>
                        </li>
                    }
                    @if (Model.CurrentPage < Model.TotalPages)
                    {
                        <li class="page-item">
                            <a class="page-link" asp-action="AuditLogs" asp-route-page="@(Model.CurrentPage + 1)"
                               asp-route-userId="@Model.UserId" asp-route-actionType="@Model.ActionType"
                               asp-route-startDate="@Model.StartDate?.ToString("yyyy-MM-dd")" asp-route-endDate="@Model.EndDate?.ToString("yyyy-MM-dd")">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                    }
                </ul>
            </nav>
        }
        else
        {
            <div class="text-center py-5">
                <i class="bi bi-journal-x display-1 text-muted"></i>
                <p class="mt-3 text-muted">Записи не найдены</p>
            </div>
        }
    </div>
</div>
