@model DocumentFlow.Models.ViewModels.AuditLogListViewModel
@{
    ViewData["Title"] = "Журнал аудита";
}

<!-- Page Header -->
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-4">
    <div>
        <h2 class="mb-1 d-flex align-items-center gap-2">
            <i class="bi bi-journal-text text-primary"></i>
            Журнал аудита
        </h2>
        <p class="text-muted mb-0">История всех действий в системе</p>
    </div>
    <a asp-action="ExportAuditLogs" asp-route-userId="@Model.UserId" asp-route-actionType="@Model.ActionType" 
       asp-route-startDate="@Model.StartDate?.ToString("yyyy-MM-dd")" asp-route-endDate="@Model.EndDate?.ToString("yyyy-MM-dd")"
       class="btn btn-success">
        <i class="bi bi-download me-1"></i>Экспорт CSV
    </a>
</div>

<!-- Filters -->
<div class="filter-panel mb-4">
    <div class="filter-header">
        <i class="bi bi-funnel-fill"></i>
        <span>Фильтры</span>
    </div>
    <form asp-action="AuditLogs" method="get" class="row g-3">
        <div class="col-md-3">
            <label class="form-label">Пользователь</label>
            <select name="userId" class="form-select">
                <option value="">Все пользователи</option>
                @foreach (var user in Model.Users)
                {
                    <option value="@user.Value" selected="@(Model.UserId == user.Value)">@user.Text</option>
                }
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">Тип действия</label>
            <select name="actionType" class="form-select">
                <option value="">Все действия</option>
                @foreach (var action in Enum.GetValues<DocumentFlow.Models.Entities.AuditActionType>())
                {
                    <option value="@action" selected="@(Model.ActionType == action)">
                        @(action switch {
                            DocumentFlow.Models.Entities.AuditActionType.Create => "Создание",
                            DocumentFlow.Models.Entities.AuditActionType.View => "Просмотр",
                            DocumentFlow.Models.Entities.AuditActionType.Edit => "Редактирование",
                            DocumentFlow.Models.Entities.AuditActionType.Delete => "Удаление",
                            DocumentFlow.Models.Entities.AuditActionType.SubmitForApproval => "Отправка на согласование",
                            DocumentFlow.Models.Entities.AuditActionType.Approve => "Согласование",
                            DocumentFlow.Models.Entities.AuditActionType.Reject => "Отклонение",
                            DocumentFlow.Models.Entities.AuditActionType.Download => "Скачивание",
                            DocumentFlow.Models.Entities.AuditActionType.UploadVersion => "Загрузка версии",
                            DocumentFlow.Models.Entities.AuditActionType.RestoreVersion => "Восстановление версии",
                            DocumentFlow.Models.Entities.AuditActionType.AddComment => "Добавление комментария",
                            DocumentFlow.Models.Entities.AuditActionType.Login => "Вход в систему",
                            DocumentFlow.Models.Entities.AuditActionType.Logout => "Выход из системы",
                            DocumentFlow.Models.Entities.AuditActionType.UserModified => "Изменение пользователя",
                            DocumentFlow.Models.Entities.AuditActionType.Archive => "Архивирование",
                            _ => action.ToString()
                        })
                    </option>
                }
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Дата с</label>
            <input type="date" name="startDate" class="form-control" value="@Model.StartDate?.ToString("yyyy-MM-dd")" />
        </div>
        <div class="col-md-2">
            <label class="form-label">Дата по</label>
            <input type="date" name="endDate" class="form-control" value="@Model.EndDate?.ToString("yyyy-MM-dd")" />
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-search me-1"></i>Поиск
            </button>
        </div>
    </form>
</div>

<!-- Data Table -->
<div class="card">
    <div class="card-body p-0">
        @if (Model.Items.Any())
        {
            <div class="table-responsive">
                <table class="table data-table mb-0">
                    <thead>
                        <tr>
                            <th style="width: 160px;">Дата и время</th>
                            <th>Пользователь</th>
                            <th>Действие</th>
                            <th>Документ</th>
                            <th>Описание</th>
                            <th>IP-адрес</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var log in Model.Items)
                        {
                            <tr class="animate-row">
                                <td>
                                    <span class="text-muted">@log.Timestamp.ToString("dd.MM.yyyy")</span>
                                    <span class="ms-1">@log.Timestamp.ToString("HH:mm:ss")</span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="user-avatar user-avatar-sm">
                                            @(log.UserFullName?.FirstOrDefault().ToString().ToUpper() ?? "?")
                                        </div>
                                        @log.UserFullName
                                    </div>
                                </td>
                                <td>
                                    @{
                                        var (badgeClass, actionText) = log.ActionType switch {
                                            DocumentFlow.Models.Entities.AuditActionType.Create => ("bg-success", "Создание"),
                                            DocumentFlow.Models.Entities.AuditActionType.View => ("bg-info text-dark", "Просмотр"),
                                            DocumentFlow.Models.Entities.AuditActionType.Edit => ("bg-warning text-dark", "Редактирование"),
                                            DocumentFlow.Models.Entities.AuditActionType.Delete => ("bg-danger", "Удаление"),
                                            DocumentFlow.Models.Entities.AuditActionType.SubmitForApproval => ("bg-info text-dark", "На согласование"),
                                            DocumentFlow.Models.Entities.AuditActionType.Approve => ("bg-success", "Согласовано"),
                                            DocumentFlow.Models.Entities.AuditActionType.Reject => ("bg-danger", "Отклонено"),
                                            DocumentFlow.Models.Entities.AuditActionType.Download => ("bg-primary", "Скачивание"),
                                            DocumentFlow.Models.Entities.AuditActionType.UploadVersion => ("bg-secondary", "Загрузка версии"),
                                            DocumentFlow.Models.Entities.AuditActionType.RestoreVersion => ("bg-secondary", "Восстановление версии"),
                                            DocumentFlow.Models.Entities.AuditActionType.AddComment => ("bg-secondary", "Комментарий"),
                                            DocumentFlow.Models.Entities.AuditActionType.Login => ("bg-primary", "Вход"),
                                            DocumentFlow.Models.Entities.AuditActionType.Logout => ("bg-dark", "Выход"),
                                            DocumentFlow.Models.Entities.AuditActionType.UserModified => ("bg-warning text-dark", "Изменение пользователя"),
                                            DocumentFlow.Models.Entities.AuditActionType.Archive => ("bg-secondary", "Архивирование"),
                                            _ => ("bg-secondary", log.ActionType.ToString())
                                        };
                                    }
                                    <span class="badge @badgeClass">@actionText</span>
                                </td>
                                <td>
                                    @if (log.DocumentId.HasValue && !string.IsNullOrEmpty(log.DocumentTitle))
                                    {
                                        <a asp-controller="Documents" asp-action="Details" asp-route-id="@log.DocumentId">
                                            @log.DocumentTitle
                                        </a>
                                    }
                                    else
                                    {
                                        <span class="text-muted">—</span>
                                    }
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(log.Description))
                                    {
                                        @log.Description
                                    }
                                    else
                                    {
                                        <span class="text-muted">—</span>
                                    }
                                </td>
                                <td><code class="text-muted">@log.IpAddress</code></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="card-footer bg-transparent border-top">
                <nav aria-label="Навигация по страницам">
                    <ul class="pagination justify-content-center mb-0">
                        @if (Model.CurrentPage > 1)
                        {
                            <li class="page-item">
                                <a class="page-link" asp-action="AuditLogs" asp-route-page="@(Model.CurrentPage - 1)"
                                   asp-route-userId="@Model.UserId" asp-route-actionType="@Model.ActionType"
                                   asp-route-startDate="@Model.StartDate?.ToString("yyyy-MM-dd")" asp-route-endDate="@Model.EndDate?.ToString("yyyy-MM-dd")">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                        }
                        @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                        {
                            <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                <a class="page-link" asp-action="AuditLogs" asp-route-page="@i"
                                   asp-route-userId="@Model.UserId" asp-route-actionType="@Model.ActionType"
                                   asp-route-startDate="@Model.StartDate?.ToString("yyyy-MM-dd")" asp-route-endDate="@Model.EndDate?.ToString("yyyy-MM-dd")">
                                    @i
                                </a>
                            </li>
                        }
                        @if (Model.CurrentPage < Model.TotalPages)
                        {
                            <li class="page-item">
                                <a class="page-link" asp-action="AuditLogs" asp-route-page="@(Model.CurrentPage + 1)"
                                   asp-route-userId="@Model.UserId" asp-route-actionType="@Model.ActionType"
                                   asp-route-startDate="@Model.StartDate?.ToString("yyyy-MM-dd")" asp-route-endDate="@Model.EndDate?.ToString("yyyy-MM-dd")">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                        }
                    </ul>
                </nav>
            </div>
        }
        else
        {
            <div class="empty-state py-5">
                <i class="bi bi-journal-x"></i>
                <h5>Записи не найдены</h5>
                <p class="mb-0">Попробуйте изменить параметры фильтрации</p>
            </div>
        }
    </div>
</div>
