@model DocumentFlow.Models.ViewModels.UserCreateViewModel
@{
    ViewData["Title"] = "Создание пользователя";
}

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a asp-action="Users">Пользователи</a></li>
        <li class="breadcrumb-item active">Создание</li>
    </ol>
</nav>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex align-items-center gap-2">
                <div class="icon-box-sm icon-box-primary">
                    <i class="bi bi-person-plus-fill"></i>
                </div>
                <h4 class="mb-0">Создание пользователя</h4>
            </div>
            <div class="card-body">
                <form asp-action="CreateUser" method="post">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                    
                    <!-- Name Section -->
                    <div class="section-header mb-3">
                        <i class="bi bi-person"></i>
                        <span>Личные данные</span>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label asp-for="LastName" class="form-label"></label>
                            <input asp-for="LastName" class="form-control" />
                            <span asp-validation-for="LastName" class="text-danger"></span>
                        </div>
                        <div class="col-md-4">
                            <label asp-for="FirstName" class="form-label"></label>
                            <input asp-for="FirstName" class="form-control" />
                            <span asp-validation-for="FirstName" class="text-danger"></span>
                        </div>
                        <div class="col-md-4">
                            <label asp-for="MiddleName" class="form-label"></label>
                            <input asp-for="MiddleName" class="form-control" />
                        </div>
                    </div>

                    <!-- Credentials Section -->
                    <div class="section-header mb-3">
                        <i class="bi bi-key"></i>
                        <span>Учётные данные</span>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label asp-for="Email" class="form-label"></label>
                            <input asp-for="Email" class="form-control" />
                            <span asp-validation-for="Email" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="Password" class="form-label"></label>
                            <div class="input-group">
                                <input asp-for="Password" class="form-control" id="passwordInput" />
                                <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="Password" class="text-danger"></span>
                            
                            <!-- Индикатор силы пароля -->
                            <div class="mt-2">
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" id="strengthBar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small id="strengthText" class="text-muted"></small>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info mb-4">
                        <h6 class="alert-heading"><i class="bi bi-info-circle me-1"></i>Требования к паролю:</h6>
                        <ul class="mb-0 small">
                            <li id="reqLength"><i class="bi bi-circle"></i> Минимум 8 символов</li>
                            <li id="reqUppercase"><i class="bi bi-circle"></i> Заглавная буква (A-Z)</li>
                            <li id="reqLowercase"><i class="bi bi-circle"></i> Строчная буква (a-z)</li>
                            <li id="reqDigit"><i class="bi bi-circle"></i> Цифра (0-9)</li>
                            <li id="reqSpecial"><i class="bi bi-circle"></i> Специальный символ (!@@#$%^&*)</li>
                        </ul>
                        <hr>
                        <p class="mb-0 small text-muted">
                            <i class="bi bi-shield-check me-1"></i>
                            При первом входе пользователь должен подтвердить email и сменить пароль.
                        </p>
                    </div>

                    <!-- Position Section -->
                    <div class="section-header mb-3">
                        <i class="bi bi-briefcase"></i>
                        <span>Должность</span>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label asp-for="Position" class="form-label"></label>
                            <input asp-for="Position" class="form-control" />
                        </div>
                        <div class="col-md-6">
                            <label asp-for="Department" class="form-label"></label>
                            <input asp-for="Department" class="form-control" />
                        </div>
                    </div>

                    <!-- Roles Section -->
                    <div class="section-header mb-3">
                        <i class="bi bi-shield-check"></i>
                        <span>Роли</span>
                    </div>

                    <div class="mb-4 pb-3 border-bottom">
                        <div class="row g-3">
                            @foreach (var role in Model.AvailableRoles)
                            {
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               name="SelectedRoles" value="@role.Name" id="role_@role.Id" />
                                        <label class="form-check-label" for="role_@role.Id">
                                            @role.DisplayName
                                        </label>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a asp-action="Users" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-1"></i>Отмена
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-1"></i>Создать пользователя
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        (function() {
            var passwordInput = document.getElementById('passwordInput');
            var strengthBar = document.getElementById('strengthBar');
            var strengthText = document.getElementById('strengthText');
            var toggleBtn = document.getElementById('togglePassword');
            
            function checkRequirements(password) {
                var requirements = {
                    length: password.length >= 8,
                    uppercase: /[A-ZА-ЯЁ]/.test(password),
                    lowercase: /[a-zа-яё]/.test(password),
                    digit: /\d/.test(password),
                    special: /[!@@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~`]/.test(password)
                };
                
                updateRequirement('reqLength', requirements.length);
                updateRequirement('reqUppercase', requirements.uppercase);
                updateRequirement('reqLowercase', requirements.lowercase);
                updateRequirement('reqDigit', requirements.digit);
                updateRequirement('reqSpecial', requirements.special);
                
                return requirements;
            }
            
            function updateRequirement(elementId, isMet) {
                var el = document.getElementById(elementId);
                if (isMet) {
                    el.innerHTML = el.innerHTML.replace('bi-circle', 'bi-check-circle-fill text-success');
                } else {
                    el.innerHTML = el.innerHTML.replace('bi-check-circle-fill text-success', 'bi-circle');
                }
            }
            
            function calculateStrength(password) {
                var score = 0;
                var reqs = checkRequirements(password);
                
                if (reqs.length) score += 20;
                if (password.length >= 12) score += 10;
                if (reqs.uppercase) score += 15;
                if (reqs.lowercase) score += 15;
                if (reqs.digit) score += 15;
                if (reqs.special) score += 15;
                if (password.length >= 16) score += 10;
                
                return Math.min(100, score);
            }
            
            function updateStrengthIndicator(password) {
                var score = calculateStrength(password);
                strengthBar.style.width = score + '%';
                
                if (score < 30) {
                    strengthBar.className = 'progress-bar bg-danger';
                    strengthText.textContent = 'Очень слабый';
                    strengthText.className = 'text-danger small';
                } else if (score < 50) {
                    strengthBar.className = 'progress-bar bg-warning';
                    strengthText.textContent = 'Слабый';
                    strengthText.className = 'text-warning small';
                } else if (score < 70) {
                    strengthBar.className = 'progress-bar bg-info';
                    strengthText.textContent = 'Средний';
                    strengthText.className = 'text-info small';
                } else if (score < 90) {
                    strengthBar.className = 'progress-bar bg-primary';
                    strengthText.textContent = 'Хороший';
                    strengthText.className = 'text-primary small';
                } else {
                    strengthBar.className = 'progress-bar bg-success';
                    strengthText.textContent = 'Отличный';
                    strengthText.className = 'text-success small';
                }
            }
            
            passwordInput.addEventListener('input', function() {
                updateStrengthIndicator(this.value);
            });
            
            toggleBtn.addEventListener('click', function() {
                var type = passwordInput.type === 'password' ? 'text' : 'password';
                passwordInput.type = type;
                this.innerHTML = type === 'password' ? '<i class="bi bi-eye"></i>' : '<i class="bi bi-eye-slash"></i>';
            });
        })();
    </script>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
