@model DocumentFlow.Models.ViewModels.ForceChangePasswordViewModel
@{
    ViewData["Title"] = "Смена пароля";
    Layout = "_Layout";
}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card shadow mt-5">
                <div class="card-header bg-warning text-dark text-center">
                    <h4 class="mb-0">
                        <i class="bi bi-key me-2"></i>Необходима смена пароля
                    </h4>
                </div>
                <div class="card-body p-4">
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="bi bi-check-circle me-2"></i>@TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle me-2"></i>
                        Для продолжения работы необходимо установить новый пароль.
                        Это требование безопасности при первом входе в систему.
                    </div>

                    <form asp-action="ForceChangePassword" method="post" id="changePasswordForm">
                        <input type="hidden" asp-for="UserId" />
                        <input type="hidden" asp-for="Email" />
                        <input type="hidden" asp-for="ReturnUrl" />

                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="text" class="form-control" value="@Model.Email" disabled />
                        </div>

                        <div class="mb-3">
                            <label asp-for="NewPassword" class="form-label"></label>
                            <div class="input-group">
                                <input asp-for="NewPassword" class="form-control" id="newPassword" />
                                <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="NewPassword" class="text-danger"></span>
                            
                            <!-- Индикатор силы пароля -->
                            <div class="mt-2">
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" id="strengthBar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small id="strengthText" class="text-muted"></small>
                            </div>
                            
                            <!-- Требования к паролю -->
                            <div class="mt-2 small" id="passwordRequirements">
                                <div id="reqLength" class="text-muted"><i class="bi bi-circle"></i> Минимум 8 символов</div>
                                <div id="reqUppercase" class="text-muted"><i class="bi bi-circle"></i> Заглавная буква</div>
                                <div id="reqLowercase" class="text-muted"><i class="bi bi-circle"></i> Строчная буква</div>
                                <div id="reqDigit" class="text-muted"><i class="bi bi-circle"></i> Цифра</div>
                                <div id="reqSpecial" class="text-muted"><i class="bi bi-circle"></i> Специальный символ (!@@#$%^&*)</div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label asp-for="ConfirmPassword" class="form-label"></label>
                            <input asp-for="ConfirmPassword" class="form-control" id="confirmPassword" />
                            <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                            <div id="passwordMatch" class="small mt-1"></div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                                <i class="bi bi-check2-circle me-2"></i>Установить новый пароль
                            </button>
                        </div>
                    </form>

                    <div class="text-center mt-3">
                        <a asp-action="Login" class="text-decoration-none">
                            <i class="bi bi-arrow-left me-1"></i>Вернуться к входу
                        </a>
                    </div>
                </div>
            </div>

            <div class="card mt-3 border-warning">
                <div class="card-body small">
                    <h6 class="card-title"><i class="bi bi-shield-lock me-2"></i>Требования к паролю:</h6>
                    <ul class="mb-0">
                        <li>Минимум 8 символов</li>
                        <li>Хотя бы одна заглавная буква (A-Z)</li>
                        <li>Хотя бы одна строчная буква (a-z)</li>
                        <li>Хотя бы одна цифра (0-9)</li>
                        <li>Хотя бы один специальный символ (!@@#$%^&* и др.)</li>
                        <li>Не должен быть распространённым паролем</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        (function() {
            var newPasswordInput = document.getElementById('newPassword');
            var confirmPasswordInput = document.getElementById('confirmPassword');
            var strengthBar = document.getElementById('strengthBar');
            var strengthText = document.getElementById('strengthText');
            var submitBtn = document.getElementById('submitBtn');
            var toggleBtn = document.getElementById('togglePassword');
            
            // Функция проверки требований
            function checkRequirements(password) {
                var requirements = {
                    length: password.length >= 8,
                    uppercase: /[A-ZА-ЯЁ]/.test(password),
                    lowercase: /[a-zа-яё]/.test(password),
                    digit: /\d/.test(password),
                    special: /[!@@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~`]/.test(password)
                };
                
                // Обновляем визуальные индикаторы
                updateRequirement('reqLength', requirements.length);
                updateRequirement('reqUppercase', requirements.uppercase);
                updateRequirement('reqLowercase', requirements.lowercase);
                updateRequirement('reqDigit', requirements.digit);
                updateRequirement('reqSpecial', requirements.special);
                
                return requirements;
            }
            
            function updateRequirement(elementId, isMet) {
                var el = document.getElementById(elementId);
                if (isMet) {
                    el.className = 'text-success';
                    el.innerHTML = el.innerHTML.replace('bi-circle', 'bi-check-circle-fill');
                } else {
                    el.className = 'text-muted';
                    el.innerHTML = el.innerHTML.replace('bi-check-circle-fill', 'bi-circle');
                }
            }
            
            function calculateStrength(password) {
                var score = 0;
                var reqs = checkRequirements(password);
                
                if (reqs.length) score += 20;
                if (password.length >= 12) score += 10;
                if (reqs.uppercase) score += 15;
                if (reqs.lowercase) score += 15;
                if (reqs.digit) score += 15;
                if (reqs.special) score += 15;
                if (password.length >= 16) score += 10;
                
                return Math.min(100, score);
            }
            
            function updateStrengthIndicator(password) {
                var score = calculateStrength(password);
                strengthBar.style.width = score + '%';
                
                if (score < 30) {
                    strengthBar.className = 'progress-bar bg-danger';
                    strengthText.textContent = 'Очень слабый';
                    strengthText.className = 'text-danger small';
                } else if (score < 50) {
                    strengthBar.className = 'progress-bar bg-warning';
                    strengthText.textContent = 'Слабый';
                    strengthText.className = 'text-warning small';
                } else if (score < 70) {
                    strengthBar.className = 'progress-bar bg-info';
                    strengthText.textContent = 'Средний';
                    strengthText.className = 'text-info small';
                } else if (score < 90) {
                    strengthBar.className = 'progress-bar bg-primary';
                    strengthText.textContent = 'Хороший';
                    strengthText.className = 'text-primary small';
                } else {
                    strengthBar.className = 'progress-bar bg-success';
                    strengthText.textContent = 'Отличный';
                    strengthText.className = 'text-success small';
                }
            }
            
            function checkFormValidity() {
                var password = newPasswordInput.value;
                var confirm = confirmPasswordInput.value;
                var reqs = checkRequirements(password);
                
                var allReqsMet = reqs.length && reqs.uppercase && reqs.lowercase && reqs.digit && reqs.special;
                var passwordsMatch = password === confirm && password.length > 0;
                
                // Обновляем индикатор совпадения
                var matchEl = document.getElementById('passwordMatch');
                if (confirm.length > 0) {
                    if (passwordsMatch) {
                        matchEl.innerHTML = '<i class="bi bi-check-circle text-success"></i> Пароли совпадают';
                        matchEl.className = 'small mt-1 text-success';
                    } else {
                        matchEl.innerHTML = '<i class="bi bi-x-circle text-danger"></i> Пароли не совпадают';
                        matchEl.className = 'small mt-1 text-danger';
                    }
                } else {
                    matchEl.innerHTML = '';
                }
                
                submitBtn.disabled = !(allReqsMet && passwordsMatch);
            }
            
            newPasswordInput.addEventListener('input', function() {
                updateStrengthIndicator(this.value);
                checkFormValidity();
            });
            
            confirmPasswordInput.addEventListener('input', checkFormValidity);
            
            // Показать/скрыть пароль
            toggleBtn.addEventListener('click', function() {
                var type = newPasswordInput.type === 'password' ? 'text' : 'password';
                newPasswordInput.type = type;
                confirmPasswordInput.type = type;
                this.innerHTML = type === 'password' ? '<i class="bi bi-eye"></i>' : '<i class="bi bi-eye-slash"></i>';
            });
        })();
    </script>
}
