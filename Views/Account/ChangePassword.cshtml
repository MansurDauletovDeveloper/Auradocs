@model DocumentFlow.Models.ViewModels.ChangePasswordViewModel
@{
    ViewData["Title"] = "Смена пароля";
}

<div class="auth-wrapper">
    <div class="auth-card">
        <div class="card-header">
            <i class="bi bi-shield-lock-fill auth-icon d-block"></i>
            <h4>Смена пароля</h4>
            <p class="text-white-50 mb-0 small">Обновите свой пароль</p>
        </div>
        <div class="card-body">
            <form asp-action="ChangePassword" method="post" id="changePasswordForm">
                <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                
                <div class="mb-4">
                    <label asp-for="CurrentPassword" class="form-label">Текущий пароль</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
                        <input asp-for="CurrentPassword" class="form-control" autocomplete="current-password" />
                    </div>
                    <span asp-validation-for="CurrentPassword" class="text-danger small"></span>
                </div>

                <hr class="my-4">
                
                <div class="mb-4">
                    <label asp-for="NewPassword" class="form-label">Новый пароль</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-key-fill"></i></span>
                        <input asp-for="NewPassword" class="form-control" autocomplete="new-password" id="newPassword" />
                        <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                    <span asp-validation-for="NewPassword" class="text-danger small"></span>
                    
                    <!-- Индикатор силы пароля -->
                    <div class="mt-2">
                        <div class="progress" style="height: 5px;">
                            <div class="progress-bar" id="strengthBar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small id="strengthText" class="text-muted"></small>
                    </div>
                    
                    <!-- Требования к паролю -->
                    <div class="mt-2 small" id="passwordRequirements">
                        <div id="reqLength" class="text-muted"><i class="bi bi-circle"></i> Минимум 8 символов</div>
                        <div id="reqUppercase" class="text-muted"><i class="bi bi-circle"></i> Заглавная буква</div>
                        <div id="reqLowercase" class="text-muted"><i class="bi bi-circle"></i> Строчная буква</div>
                        <div id="reqDigit" class="text-muted"><i class="bi bi-circle"></i> Цифра</div>
                        <div id="reqSpecial" class="text-muted"><i class="bi bi-circle"></i> Специальный символ</div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label asp-for="ConfirmPassword" class="form-label">Подтверждение пароля</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-key"></i></span>
                        <input asp-for="ConfirmPassword" class="form-control" autocomplete="new-password" id="confirmPassword" />
                    </div>
                    <span asp-validation-for="ConfirmPassword" class="text-danger small"></span>
                    <div id="passwordMatch" class="small mt-1"></div>
                </div>
                
                <div class="d-flex gap-3">
                    <a asp-action="Profile" class="btn btn-outline-secondary flex-grow-1">
                        <i class="bi bi-arrow-left me-1"></i>Назад
                    </a>
                    <button type="submit" class="btn btn-primary flex-grow-1" id="submitBtn">
                        <i class="bi bi-check-lg me-1"></i>Сохранить
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        (function() {
            var newPasswordInput = document.getElementById('newPassword');
            var confirmPasswordInput = document.getElementById('confirmPassword');
            var strengthBar = document.getElementById('strengthBar');
            var strengthText = document.getElementById('strengthText');
            var toggleBtn = document.getElementById('togglePassword');
            
            function checkRequirements(password) {
                var requirements = {
                    length: password.length >= 8,
                    uppercase: /[A-ZА-ЯЁ]/.test(password),
                    lowercase: /[a-zа-яё]/.test(password),
                    digit: /\d/.test(password),
                    special: /[!@@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~`]/.test(password)
                };
                
                updateRequirement('reqLength', requirements.length);
                updateRequirement('reqUppercase', requirements.uppercase);
                updateRequirement('reqLowercase', requirements.lowercase);
                updateRequirement('reqDigit', requirements.digit);
                updateRequirement('reqSpecial', requirements.special);
                
                return requirements;
            }
            
            function updateRequirement(elementId, isMet) {
                var el = document.getElementById(elementId);
                if (isMet) {
                    el.className = 'text-success';
                    el.innerHTML = el.innerHTML.replace('bi-circle', 'bi-check-circle-fill');
                } else {
                    el.className = 'text-muted';
                    el.innerHTML = el.innerHTML.replace('bi-check-circle-fill', 'bi-circle');
                }
            }
            
            function calculateStrength(password) {
                var score = 0;
                var reqs = checkRequirements(password);
                
                if (reqs.length) score += 20;
                if (password.length >= 12) score += 10;
                if (reqs.uppercase) score += 15;
                if (reqs.lowercase) score += 15;
                if (reqs.digit) score += 15;
                if (reqs.special) score += 15;
                if (password.length >= 16) score += 10;
                
                return Math.min(100, score);
            }
            
            function updateStrengthIndicator(password) {
                var score = calculateStrength(password);
                strengthBar.style.width = score + '%';
                
                if (score < 30) {
                    strengthBar.className = 'progress-bar bg-danger';
                    strengthText.textContent = 'Очень слабый';
                    strengthText.className = 'text-danger small';
                } else if (score < 50) {
                    strengthBar.className = 'progress-bar bg-warning';
                    strengthText.textContent = 'Слабый';
                    strengthText.className = 'text-warning small';
                } else if (score < 70) {
                    strengthBar.className = 'progress-bar bg-info';
                    strengthText.textContent = 'Средний';
                    strengthText.className = 'text-info small';
                } else if (score < 90) {
                    strengthBar.className = 'progress-bar bg-primary';
                    strengthText.textContent = 'Хороший';
                    strengthText.className = 'text-primary small';
                } else {
                    strengthBar.className = 'progress-bar bg-success';
                    strengthText.textContent = 'Отличный';
                    strengthText.className = 'text-success small';
                }
            }
            
            function checkPasswordMatch() {
                var password = newPasswordInput.value;
                var confirm = confirmPasswordInput.value;
                var matchEl = document.getElementById('passwordMatch');
                
                if (confirm.length > 0) {
                    if (password === confirm) {
                        matchEl.innerHTML = '<i class="bi bi-check-circle text-success"></i> Пароли совпадают';
                        matchEl.className = 'small mt-1 text-success';
                    } else {
                        matchEl.innerHTML = '<i class="bi bi-x-circle text-danger"></i> Пароли не совпадают';
                        matchEl.className = 'small mt-1 text-danger';
                    }
                } else {
                    matchEl.innerHTML = '';
                }
            }
            
            newPasswordInput.addEventListener('input', function() {
                updateStrengthIndicator(this.value);
                checkPasswordMatch();
            });
            
            confirmPasswordInput.addEventListener('input', checkPasswordMatch);
            
            toggleBtn.addEventListener('click', function() {
                var type = newPasswordInput.type === 'password' ? 'text' : 'password';
                newPasswordInput.type = type;
                confirmPasswordInput.type = type;
                this.innerHTML = type === 'password' ? '<i class="bi bi-eye"></i>' : '<i class="bi bi-eye-slash"></i>';
            });
        })();
    </script>
}
