@model DocumentFlow.Models.ViewModels.DashboardViewModel
@using DocumentFlow.Models.Entities
@{
    ViewData["Title"] = "Главная";
    var roleDisplayName = DocumentFlow.Models.Entities.SystemRoles.GetDisplayName(Model.PrimaryRole);
}

<!-- Page Header -->
<div class="page-header mb-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
        <div>
            <h2 class="mb-1">
                <span class="text-gradient">Добро пожаловать</span>, @Model.UserName!
            </h2>
            <p class="text-muted mb-0 d-flex align-items-center gap-2 flex-wrap">
                <span class="badge bg-primary">@roleDisplayName</span>
                @if (Model.Roles.Count > 1)
                {
                    @foreach (var role in Model.Roles.Skip(1))
                    {
                        <span class="badge bg-secondary">@DocumentFlow.Models.Entities.SystemRoles.GetDisplayName(role)</span>
                    }
                }
            </p>
        </div>
        <a asp-controller="Documents" asp-action="Create" class="btn btn-primary">
            <i class="bi bi-plus-lg me-1"></i>Новый документ
        </a>
    </div>
</div>

<!-- Stats Cards -->
<div class="row g-4 mb-4">
    <div class="col-6 col-lg-3">
        <div class="card stat-card bg-primary text-white h-100">
            <div class="card-body">
                <i class="bi bi-file-earmark-text stat-icon"></i>
                <div class="stat-label text-white-50 mb-1">Мои документы</div>
                <div class="stat-value">@Model.MyDocumentsCount</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="card stat-card bg-warning h-100">
            <div class="card-body">
                <i class="bi bi-hourglass-split stat-icon"></i>
                <div class="stat-label text-dark mb-1" style="opacity: 0.7">На согласовании</div>
                <div class="stat-value text-dark">@Model.MyPendingCount</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="card stat-card bg-success text-white h-100">
            <div class="card-body">
                <i class="bi bi-check-circle stat-icon"></i>
                <div class="stat-label text-white-50 mb-1">Утверждено</div>
                <div class="stat-value">@Model.MyApprovedCount</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="card stat-card bg-danger text-white h-100">
            <div class="card-body">
                <i class="bi bi-x-circle stat-icon"></i>
                <div class="stat-label text-white-50 mb-1">Отклонено</div>
                <div class="stat-value">@Model.MyRejectedCount</div>
            </div>
        </div>
    </div>
</div>

@if (User.IsInRole("Manager") || User.IsInRole("Administrator"))
{
    <!-- Approvals Section -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card border-warning h-100">
                <div class="card-body d-flex align-items-center gap-3">
                    <div class="icon-box icon-box-warning">
                        <i class="bi bi-clock-history"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="text-muted small">Ожидают согласования</div>
                        <div class="h3 mb-0">@Model.PendingApprovalsCount</div>
                    </div>
                    <a asp-controller="Approval" asp-action="Index" class="btn btn-warning">
                        <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
        @if (Model.OverdueApprovalsCount > 0)
        {
            <div class="col-md-6">
                <div class="card border-danger h-100">
                    <div class="card-body d-flex align-items-center gap-3">
                        <div class="icon-box icon-box-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="text-danger small">Просрочено</div>
                            <div class="h3 mb-0 text-danger">@Model.OverdueApprovalsCount</div>
                        </div>
                        <a asp-controller="Approval" asp-action="Index" class="btn btn-danger">
                            <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                </div>
            </div>
        }
    </div>
}

@if (User.IsInRole("Administrator"))
{
    <!-- Admin Stats -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body d-flex align-items-center gap-3">
                    <div class="icon-box icon-box-info">
                        <i class="bi bi-people-fill"></i>
                    </div>
                    <div>
                        <div class="h4 mb-0">@Model.TotalUsersCount</div>
                        <div class="text-muted small">Пользователей</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body d-flex align-items-center gap-3">
                    <div class="icon-box icon-box-primary">
                        <i class="bi bi-files"></i>
                    </div>
                    <div>
                        <div class="h4 mb-0">@Model.TotalDocumentsCount</div>
                        <div class="text-muted small">Всего документов</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body d-flex align-items-center gap-3">
                    <div class="icon-box icon-box-success">
                        <i class="bi bi-calendar-check"></i>
                    </div>
                    <div>
                        <div class="h4 mb-0">@Model.TodayDocumentsCount</div>
                        <div class="text-muted small">Документов сегодня</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<div class="row g-4">
    <!-- Recent Documents -->
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0 d-flex align-items-center gap-2">
                    <i class="bi bi-clock-history text-primary"></i>
                    Последние документы
                </h5>
                <a asp-controller="Documents" asp-action="Index" class="btn btn-sm btn-outline-primary">
                    Все документы
                </a>
            </div>
            <div class="card-body p-0">
                @if (Model.RecentDocuments.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th style="padding-left: 1.5rem;">Документ</th>
                                    <th>Тип</th>
                                    <th>Статус</th>
                                    <th style="padding-right: 1.5rem;">Дата</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var doc in Model.RecentDocuments)
                                {
                                    <tr class="cursor-pointer" onclick="window.location='@Url.Action("Details", "Documents", new { id = doc.Id })'">
                                        <td style="padding-left: 1.5rem;">
                                            <div class="fw-semibold">@doc.Title</div>
                                            <code class="small">@doc.RegistrationNumber</code>
                                        </td>
                                        <td>@GetDocumentTypeName(doc.DocumentType)</td>
                                        <td>
                                            <span class="badge @GetStatusBadgeClass(doc.Status)">
                                                @GetStatusName(doc.Status)
                                            </span>
                                        </td>
                                        <td style="padding-right: 1.5rem;">
                                            <span class="text-muted">@doc.CreatedAt.ToLocalTime().ToString("dd.MM.yyyy")</span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="empty-state py-5">
                        <i class="bi bi-inbox"></i>
                        <h5>Документов пока нет</h5>
                        <p class="mb-3">Создайте свой первый документ</p>
                        <a asp-controller="Documents" asp-action="Create" class="btn btn-primary">
                            <i class="bi bi-plus-lg me-1"></i>Создать документ
                        </a>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Notifications -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0 d-flex align-items-center gap-2">
                    <i class="bi bi-bell text-warning"></i>
                    Уведомления
                </h5>
                @if (Model.UnreadNotificationsCount > 0)
                {
                    <span class="badge bg-danger">@Model.UnreadNotificationsCount</span>
                }
            </div>
            <div class="card-body p-0">
                @if (Model.RecentNotifications.Any())
                {
                    @foreach (var notification in Model.RecentNotifications)
                    {
                        <a asp-controller="Documents" asp-action="Details" asp-route-id="@notification.DocumentId" 
                           class="notification-item d-block text-decoration-none @(!notification.IsRead ? "unread" : "")">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="fw-semibold text-gray-800">@notification.Title</div>
                                <span class="notification-time">@notification.CreatedAt.ToLocalTime().ToString("dd.MM HH:mm")</span>
                            </div>
                            <div class="text-muted small mt-1">@notification.Message</div>
                        </a>
                    }
                    <div class="p-3 text-center border-top">
                        <a asp-controller="Notifications" asp-action="Index" class="btn btn-sm btn-link">
                            Все уведомления <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                }
                else
                {
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-bell-slash" style="font-size: 2rem; opacity: 0.5;"></i>
                        <p class="mb-0 mt-2">Нет новых уведомлений</p>
                    </div>
                }
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0 d-flex align-items-center gap-2">
                    <i class="bi bi-lightning-charge text-warning"></i>
                    Быстрые действия
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a asp-controller="Documents" asp-action="Create" class="quick-action-btn text-decoration-none">
                        <i class="bi bi-plus-circle-fill"></i>
                        <span>Создать документ</span>
                    </a>
                    <a asp-controller="Documents" asp-action="Index" class="quick-action-btn text-decoration-none">
                        <i class="bi bi-search"></i>
                        <span>Найти документ</span>
                    </a>
                    @if (User.IsInRole("Manager") || User.IsInRole("Administrator"))
                    {
                        <a asp-controller="Approval" asp-action="Index" class="quick-action-btn text-decoration-none">
                            <i class="bi bi-clipboard2-check"></i>
                            <span>Просмотреть согласования</span>
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .cursor-pointer { cursor: pointer; }
    .text-gray-800 { color: var(--gray-800); }
</style>

@functions {
    string GetDocumentTypeName(DocumentType type) => type switch
    {
        DocumentType.Application => "Заявление",
        DocumentType.Order => "Приказ",
        DocumentType.Contract => "Договор",
        DocumentType.Act => "Акт",
        DocumentType.Memo => "Служебная записка",
        DocumentType.Report => "Отчёт",
        DocumentType.Protocol => "Протокол",
        _ => "Другое"
    };

    string GetStatusName(DocumentStatus status) => status switch
    {
        DocumentStatus.Draft => "Черновик",
        DocumentStatus.Pending => "На согласовании",
        DocumentStatus.Approved => "Утверждён",
        DocumentStatus.Rejected => "Отклонён",
        DocumentStatus.Archived => "Архив",
        _ => "Неизвестно"
    };

    string GetStatusBadgeClass(DocumentStatus status) => status switch
    {
        DocumentStatus.Draft => "bg-secondary",
        DocumentStatus.Pending => "bg-warning text-dark",
        DocumentStatus.Approved => "bg-success",
        DocumentStatus.Rejected => "bg-danger",
        DocumentStatus.Archived => "bg-info",
        _ => "bg-secondary"
    };
}
